import requests
from api.github_api import GitHubAPI
from utils.csv_writer import CSVWriter

class VulnerabilityService:
    def __init__(
            self, 
            github_api: GitHubAPI, 
            csv_writer: CSVWriter
        ):
        self.github_api = github_api
        self.csv_writer = csv_writer

    def process(
            self,
            repo: str,
            ecosystem: str,
            source_file: str,
            dependency_name: str, 
            dependency_version: str
        ):
        try:
            vulnerabilities = self.github_api.check_vulnerabilities(
                ecosystem,
                dependency_name,
                dependency_version
            )
            
            for vuln in vulnerabilities:
                vuln["repo"] = repo
                vuln["ecosystem"] = ecosystem
                vuln["source_file"] = source_file
                self.csv_writer.append_row(vuln)
            print(f"Found {len(vulnerabilities)} vulnerabilities for \
                  {dependency_name}@{dependency_version}")
        except Exception as e:
            print(f"Error checking vulnerabilities for \
                  {dependency_name}@{dependency_version}: {e}")